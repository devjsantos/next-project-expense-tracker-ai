generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id  String @id @default(uuid())
  clerkUserId String @unique
  email String @unique
  name  String?
  imageUrl String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  records Records[]
  budgets Budget[]
  emailReports EmailReport[]
  recurringExpenses RecurringExpense[]
  notifications Notification[]
}
model Records{
  id String @id @default(uuid())
  text String
  amount Float
  category String @default("Other")
  date DateTime @default(now())
  userId String
  user User @relation(fields: [userId], references: [clerkUserId], onDelete: Cascade)
  // Optional link to a recurring expense rule (if this record was generated by a recurring item)
  recurringId String?
  recurring RecurringExpense? @relation("RecurringToRecords", fields: [recurringId], references: [id], onDelete: SetNull)
  createdAt DateTime @default(now())
  @@index([userId])
  @@index([recurringId])
}

model Budget {
  id String @id @default(uuid())
  userId String
  user User @relation(fields: [userId], references: [clerkUserId], onDelete: Cascade)
  // Monthly budget total in the user's currency
  monthlyTotal Float @default(0)
  // Which month this budget refers to (first day of month as DateTime)
  monthStart DateTime
  // period type: 'monthly' | 'weekly' | 'custom'
  periodType String @default("monthly")
  // optional period start/end for weekly/custom budgets
  periodStart DateTime?
  periodEnd DateTime?
  allocations BudgetAllocation[]
  budgetAlertThreshold Float @default(0.8) // User's desired alert threshold (0.5-0.8)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Enable budget rollover to next month
  rolloverEnabled Boolean @default(false)
  // Amount rolled over from previous month
  rolloverAmount Float @default(0)
  @@index([userId])
}

model RecurringExpense {
  id String @id @default(uuid())
  userId String
  user User @relation(fields: [userId], references: [clerkUserId], onDelete: Cascade)
  text String
  amount Float
  category String @default("Other")
  startDate DateTime
  frequency String // e.g. 'monthly', 'weekly', 'yearly'
  active Boolean @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  records Records[] @relation("RecurringToRecords")
  @@index([userId])
}

model BudgetAllocation {
  id String @id @default(uuid())
  budgetId String
  budget Budget @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  category String
  amount Float @default(0)
  createdAt DateTime @default(now())
  @@index([budgetId])
}

model EmailReport {
  id String @id @default(uuid())
  userId String
  user User @relation(fields: [userId], references: [clerkUserId], onDelete: Cascade)
  email String
  subject String
  provider String?
  status String
  providerResponse String? // store raw provider response or message
  createdAt DateTime @default(now())
  @@index([userId])
}

model Notification {
  id String @id @default(uuid())
  userId String
  user User @relation(fields: [userId], references: [clerkUserId], onDelete: Cascade)
  type String // 'info' | 'warning' | 'critical'
  title String
  message String
  read Boolean @default(false)
  createdAt DateTime @default(now())
  @@index([userId])
}